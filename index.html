<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karl Josefsson Data Viz Final Project</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        header, main {
            text-align: center;
            margin: 0 auto;
            max-width: 800px;
        }
        /* Heatmap styles */
        #heatmap-container {
            margin: 20px auto;
            width: 100%;
            height: 600px;
            position: relative;
        }
        svg {
            width: 100%;
            height: 600px;
        }
        #slider-container {
            text-align: center;
            margin: 10px 0;
        }
        #current-date {
            font-weight: bold;
            margin-left: 10px;
        }
        .country {
            stroke: #fff;
            stroke-width: 0.5px;
            cursor: pointer;
        }
        .tooltip {
            position: absolute;
            pointer-events: none;
            z-index: 10;
            padding: 8px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.2);
            font-size: 14px;
            display: none;
        }
        .legend {
            position: absolute;
            bottom: 30px;
            right: 30px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
            box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.2);
        }
        .legend-title {
            font-weight: bold;
            text-align: center;
            margin-bottom: 5px;
        }
        .legend-container {
            height: 20px;
            width: 200px;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Sweden's COVID-19 approach, a success or a failure?</h1>
        <h2>Author: Karl Fredrik Hu Josefsson</h2>
        <h4>Email: kfhujosefsson@dons.usfca.edu</h4>
    </header>

    <main>
        <p>When the COVID-19 pandemic struck, countries around the world scrambled to implement policies to slow the spread of the virus—lockdowns, mask mandates, and social distancing became the new normal. In Scandinavia, three neighboring countries—Sweden, Norway, and Denmark—share similar cultures, economies, healthcare systems, and demographics. But when the crisis hit, one of them made a very different choice. Looking at the lockdown time line below, you can see that there wasn't any lockdowns in Sweden, while Norway and Denmark implemented strict lockdowns. The question is, was this a success or a failure?</p>
        <img src="lockdow-timeline.png" alt="Timeline of lockdowns in Scandinavian countries" style="max-width: 100%; height: auto; display: block; margin: 20px auto;">

        <p>Now that we are familiar with the context, let's start looking at some COVID-19 data. As the pandemic started to take its flight during the spring of 2020, the number of confirmed COVID-19 cases started to rapidly increase. Looking at the heatmap below, the spring of 2020 all the way through half of 2021 shows a very big difference in regards to the countries response. During this period, you can clearly see a large contrast seeing Sweden blowing up in confirmed cases while its neighboring countries are in lockdown.</p>

        <!-- Heatmap Section -->
        <section>
            <h2>COVID Cases in Scandinavia Over Time</h2>
            <div id="heatmap-container"></div>
            <div id="slider-container">
                <input type="range" id="date-slider" min="0" max="0" step="1">
                <span id="current-date"></span>
            </div>
            <div class="tooltip" id="heatmap-tooltip"></div>
        </section>
    </main>

    <script>
    // Heatmap script adapted from heatmap.html
    const width = 800, height = 600;
    const svg = d3.select('#heatmap-container')
      .append('svg')
      .attr('viewBox', `0 0 ${width} ${height}`)
      .attr('preserveAspectRatio', 'xMidYMid meet');

    const tooltip = d3.select('#heatmap-tooltip');

    Promise.all([
      d3.json('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json'),
      d3.csv('https://gist.githubusercontent.com/karldif01/9daa30f0d38b7cd36f17872e5a893729/raw/4d7eff95c8cf5d6e5e1b0d79990863d8dccf4c07/gistfile1.txt', d => ({
        country: d.Country,
        date: new Date(d.date),
        cases: +d.total_cases
      }))
    ]).then(([geo, rows]) => {
      const scandi = new Set(['Sweden','Denmark','Norway']);
      geo.features = geo.features.filter(f => scandi.has(f.properties.name));

      const dataByDate = d3.group(rows, d => +d.date);
      const dates = Array.from(dataByDate.keys()).sort((a,b) => a - b);
      const lookup = new Map();
      dataByDate.forEach((recs, t) => {
        lookup.set(t, new Map(recs.map(r => [r.country, r.cases])));
      });

      const projection = d3.geoMercator().fitSize([width, height], geo);
      const path = d3.geoPath().projection(projection);

      const maxColorValue = 3500000;
      const color = d3.scaleSequential(d3.interpolateOrRd).domain([0, maxColorValue]);

      const countries = svg.append('g')
        .selectAll('path')
        .data(geo.features)
        .join('path')
        .attr('class', 'country')
        .attr('d', path)
        .attr('fill', '#eee')
        .on('mouseover', (event, d) => {
          tooltip.style('display', 'block');
        })
        .on('mousemove', (event, d) => {
          const date = +slider.property('value');
          const t = dates[date];
          const dateStr = d3.timeFormat('%Y-%m-%d')(new Date(t));
          const name = d.properties.name;
          const c = lookup.get(t).get(name) || 0;
          tooltip
            .html(`<strong>${name}</strong><br/>Date: ${dateStr}<br/>Cases: ${c.toLocaleString()}`)
            .style('left', event.pageX + 10 + 'px')
            .style('top', event.pageY - 28 + 'px');
        })
        .on('mouseout', () => tooltip.style('display', 'none'));

      const slider = d3.select('#date-slider')
        .attr('max', dates.length - 1)
        .property('value', 0)
        .on('input', update);

      d3.select('#current-date').text(d3.timeFormat('%Y-%m-%d')(new Date(dates[0])));

      const legend = d3.select('body')
        .append('div')
        .attr('class', 'legend');
      legend.append('div').attr('class', 'legend-title').text('COVID-19 Cases');
      const legendContainer = legend.append('div').attr('class', 'legend-container');
      const legendSvg = legendContainer.append('svg').attr('width', 200).attr('height', 20);
      const defs = legendSvg.append('defs');
      const linearGradient = defs.append('linearGradient').attr('id', 'legend-gradient')
        .attr('x1','0%').attr('y1','0%').attr('x2','100%').attr('y2','0%');
      const numStops = 10;
      for (let i=0; i<=numStops; i++) {
        const offset = i / numStops;
        const stopValue = offset * maxColorValue;
        linearGradient.append('stop')
          .attr('offset', `${offset*100}%`)
          .attr('stop-color', color(stopValue));
      }
      legendSvg.append('rect').attr('width', 200).attr('height', 20).style('fill', 'url(#legend-gradient)');
      const labels = legend.append('div').style('display','flex').style('justify-content','space-between').style('font-size','12px');
      labels.append('span').text('0');
      labels.append('span').text('3.5M');

      update();
      function update() {
        const i = +slider.property('value');
        const t = dates[i];
        const dateStr = d3.timeFormat('%Y-%m-%d')(new Date(t));
        d3.select('#current-date').text(dateStr);
        const todayMap = lookup.get(t);
        countries.attr('fill', d => {
          const name = d.properties.name;
          const c = todayMap.get(name) || 0;
          return c ? color(c) : '#ccc';
        });
      }
    });
    </script>

    <p>
        With a sudden new disease, a lot of problem in healthcare can arise. Below we can see a chart of the respective hospital occupancy. Here you can see that the trend among the three are pretty similar. However, looking at the combined graph we can see how Sweden's hospital occupancy is much higher than the other two countries. This could be due to the fact that Sweden didn't have any lockdowns, and therefore a lot of people were infected at the same time.
    </p>

    <li> Small Multiples Charts - <a href="https://vizhub.com/karldif01/6935595019d748c8bd4f746977672f51">Hospital occupancy</a></li>

    <p>
        Moving onto some Social & Economical Metrics, we have two graphs showing annual GDP and unemployment rate. Here we can see Sweden seeing the biggest fall in terms of GDP as well as a big rise in unemployment.
    </p>

    <li> Multiline Charts - <a href="https://vizhub.com/karldif01/9c1964e21c75408c9baf5cb9331a1e22">GDP & Unemployment</a></li>
    
    <p> Lastly and most importantly, here is an animation of deaths per 10 million as we move through the pandemic. Comparing the three lines shows that Sweden had a early rise while the Denmark and Norway's numbers are low, which align well with the peridods of Sweden not putting in restrictions which is what the other countries did to stay afloat. </p>

    <li> Animated Scatterplot/LineChart - <a href="https://vizhub.com/karldif01/6ebc91d5d7b249c18d6d07c19e5f6ff4">Deaths per 10 million</a></li>
</body>
</html>